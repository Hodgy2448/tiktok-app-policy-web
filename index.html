<!doctype html><meta charset="utf-8">
<title>Connect TikTok</title>
<main style="max-width:720px;margin:40px auto;font:16px/1.6 system-ui">
  <h1>Direct Poster (Personal)</h1>

  <!-- Connect / OAuth -->
  <button id="connect">Connect TikTok (OAuth)</button>
  <p><a href="./privacy.html">Privacy</a> · <a href="./tos.html">Terms</a></p>

  <hr style="margin:24px 0;opacity:.2">

  <!-- Proxy + token + upload UI -->
  <h2 style="font-size:18px;margin:0 0 8px">Direct Post (FILE_UPLOAD)</h2>

  <label>Proxy base URL (Cloudflare/Vercel)
    <small style="opacity:.7">https://tiktok-proxy.populargamingcontent.workers.dev/</small>
  </label>
  <input id="proxy" type="url" placeholder="https://tiktok-proxy.populargamingcontent.workers.dev"
         style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;margin-bottom:8px">

  <label>Access token (paste a fresh one)</label>
  <input id="accessToken" type="password" placeholder="Bearer access token"
         style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px">

  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
    <div style="flex:1;min-width:220px">
      <label>Caption</label>
      <input id="title" type="text" value="Demo via API #review"
             style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px">
    </div>
    <div style="flex:1;min-width:220px">
      <label>Video file</label>
      <input id="file" type="file" accept="video/*">
    </div>
  </div>

  <button id="uploadBtn" style="margin-top:12px;padding:10px 14px;border-radius:8px">
    Post to TikTok
  </button>

  <h3 style="margin:18px 0 6px">Log</h3>
  <pre id="log" style="background:#f6f7f8;border:1px solid #ddd;border-radius:8px;padding:12px;max-height:320px;overflow:auto"></pre>
</main>

<script>
  // ===== OAuth connect (unchanged) =====
  const clientKey   = 'sbawosht5mqk22behl'; // from TikTok portal
  const redirectUri = 'https://hodgy2448.github.io/tiktok-app-policy-web/oauth/callback.html';
  const scope       = 'video.publish';
  const state       = Math.random().toString(36).slice(2); // any CSRF token you like

  document.getElementById('connect').onclick = () => {
    const authUrl =
      'https://www.tiktok.com/v2/auth/authorize/' +
      '?client_key='   + encodeURIComponent(clientKey) +
      '&scope='        + encodeURIComponent(scope) +
      '&response_type=code' +
      '&redirect_uri=' + encodeURIComponent(redirectUri) +
      '&state='        + encodeURIComponent(state);
    location.href = authUrl;
  };

  // ===== Helpers =====
  const $ = id => document.getElementById(id);
  const log = (...a) => {
    $('log').textContent += a.map(x => typeof x==='string' ? x : JSON.stringify(x,null,2)).join(' ') + '\n';
    $('log').scrollTop = $('log').scrollHeight;
  };
  // Persist proxy base locally
  (function initProxySetting(){
    const saved = localStorage.getItem('tt_proxy_base');
    if (saved) $('proxy').value = saved;
    $('proxy').addEventListener('change', () => {
      localStorage.setItem('tt_proxy_base', $('proxy').value.trim());
    });
  })();
  // Optional: auto-fill access token from URL hash: #access_token=...
  (function autoFillTokenFromHash(){
    const m = location.hash.match(/access_token=([^&]+)/);
    if (m) {
      const tok = decodeURIComponent(m[1]);
      $('accessToken').value = tok;
      sessionStorage.setItem('tt_access_token', tok);
    }
  })();

  async function postJson(url, headers, body) {
    let resp;
    try {
      resp = await fetch(url, {
        method: 'POST',
        headers: Object.assign({'Content-Type':'application/json; charset=UTF-8'}, headers || {}),
        body: JSON.stringify(body || {})
      });
    } catch (e) {
      // Network/CORS preflight issues show up here
      log('Network error calling', url, String(e));
      throw e;
    }
    const text = await resp.text();
    let json;
    try { json = text ? JSON.parse(text) : {}; } catch { json = { raw:text }; }
    return { ok: resp.ok, status: resp.status, json };
  }

  // ===== Direct Post (with proxy for init/status) =====
  $('uploadBtn').onclick = async () => {
    try {
      const proxyBase = $('proxy').value.trim().replace(/\/+$/,''); // no trailing slash
      if (!proxyBase) { alert('Enter your proxy base URL first.'); return; }

      const accessToken = $('accessToken').value.trim();
      if (!accessToken) { alert('Paste your access token first.'); return; }

      const file = $('file').files?.[0];
      if (!file) { alert('Choose a video file.'); return; }

      const title = $('title').value || 'Demo via API';

      // A) init (via proxy)
      log('Init Direct Post…');
      const initBody = {
        post_info: { title, privacy_level: 'SELF_ONLY' }, // unaudited apps => private
        source_info: {
          source: 'FILE_UPLOAD',
          video_size: file.size,
          chunk_size: file.size,
          total_chunk_count: 1
        }
      };

      const initCall = await postJson(
        proxyBase + '/init',
        { 'Authorization': 'Bearer ' + accessToken },
        initBody
      );
      log('init response:', initCall.json);
      if (!initCall.ok) { alert('Init failed (see Log).'); return; }

      const publishId = initCall.json?.data?.publish_id;
      const uploadUrl = initCall.json?.data?.upload_url;
      if (!publishId || !uploadUrl) { alert('Missing publish_id/upload_url from init.'); return; }

      // B) upload (single chunk) — direct to TikTok signed URL
      log('Uploading…');
      const upHeaders = new Headers();
      upHeaders.set('Content-Type', file.type || 'video/mp4');
      upHeaders.set('Content-Range', `bytes 0-${file.size - 1}/${file.size}`);

      const upResp = await fetch(uploadUrl, { method: 'PUT', headers: upHeaders, body: file });
      const upText = await upResp.text();
      log('upload status:', upResp.status, upResp.statusText);
      if (upText) log('upload body:', upText);
      if (!upResp.ok) { alert('Upload failed (see Log).'); return; }

      // C) poll status (via proxy)
      log('Polling status…');
      let status = 'UNKNOWN';
      for (let i = 0; i < 30; i++) {
        await new Promise(r => setTimeout(r, 3000));
        const statCall = await postJson(
          proxyBase + '/status',
          { 'Authorization': 'Bearer ' + accessToken },
          { publish_id: publishId }
        );
        log(`poll ${i+1}:`, statCall.json);
        if (!statCall.ok) { alert('Status poll failed (see Log).'); return; }
        status = statCall.json?.data?.publish_status || 'UNKNOWN';
        if (['PUBLISH_COMPLETE','PUBLISH_FAILED','PUBLISH_PARTIAL_FAIL'].includes(status)) break;
      }

      if (status === 'PUBLISH_COMPLETE') alert('Success: PUBLISH_COMPLETE');
      else alert('Finished with status: ' + status + ' (see Log).');

    } catch (err) {
      console.error(err);
      log('Error:', String(err));
      alert('Something went wrong. See Log.');
    }
  };
</script>
